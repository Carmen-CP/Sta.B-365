<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Santa Br√≠gida ¬∑ 15 oraciones</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#060a16">

  <style>
    :root{
      /* === ESTILO 2 (m√°s brillante/glow) === */
      --bg:#060a16;
      --card: rgba(255,255,255,.075);
      --card2: rgba(255,255,255,.045);
      --line: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.76);
      --accent:#77ffd6;
      --accent2:#86b6ff;
      --danger:#ff6b88;
      --radius: 18px;
      --shadow: 0 22px 80px rgba(0,0,0,.55);
      --shadow2: 0 12px 40px rgba(0,0,0,.40);

      --glowA: 0 0 0 1px rgba(255,255,255,.06),
               0 18px 70px rgba(0,0,0,.55);
      --glowAccent: 0 0 0 1px rgba(255,255,255,.07),
                    0 0 28px rgba(119,255,214,.22),
                    0 0 52px rgba(134,182,255,.16);
    }
    *{ box-sizing:border-box; }
    html, body{
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 750px at 12% -10%, rgba(134,182,255,.34), transparent 62%),
        radial-gradient(950px 720px at 90% 6%, rgba(119,255,214,.26), transparent 58%),
        radial-gradient(900px 700px at 50% 115%, rgba(255,107,136,.16), transparent 62%),
        radial-gradient(700px 520px at 50% 40%, rgba(255,255,255,.05), transparent 58%),
        var(--bg);
    }
    header{
      position: sticky;
      top:0;
      z-index: 10;
      padding: 20px 16px 14px;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(6,10,22,.92), rgba(6,10,22,.42));
      border-bottom: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 60px rgba(0,0,0,.45);
    }
    h1{
      margin:0;
      text-align:center;
      font-size: 21px;
      letter-spacing:.2px;
      font-weight: 1000;
      text-shadow: 0 0 26px rgba(134,182,255,.16);
    }
    .sub{
      text-align:center;
      margin-top:6px;
      font-size: 13px;
      color: var(--muted);
      line-height:1.35;
      max-width: 720px;
      margin-left:auto;
      margin-right:auto;
    }
    .wrap{ max-width: 1120px; margin:0 auto; padding: 16px; }

    .tabs{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .tab{
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      cursor:pointer;
      font-weight: 1000;
      box-shadow: var(--shadow2);
      transition: transform .12s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.22); }
    .tab.active{
      color: rgba(0,0,0,.85);
      border-color: transparent;
      background: linear-gradient(135deg, rgba(119,255,214,.98), rgba(134,182,255,.92));
      box-shadow: var(--glowAccent);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      position:relative;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: var(--radius);
      box-shadow: var(--glowA);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 240px at 10% 0%, rgba(134,182,255,.14), transparent 60%),
        radial-gradient(900px 240px at 90% 0%, rgba(119,255,214,.12), transparent 60%);
      opacity:.9;
    }
    .hd{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: rgba(255,255,255,.03);
      position:relative;
      z-index:1;
    }
    .bd{ padding: 14px; position:relative; z-index:1; }

    .title{ font-weight: 1000; letter-spacing:.2px; }
    .muted{ color: var(--muted); }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
      margin-top: 10px;
    }

    button{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 1000;
      box-shadow: var(--shadow2);
      transition: transform .12s ease, background .2s ease, border-color .2s ease, opacity .2s ease, box-shadow .2s ease;
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.22); }
    button:active{ transform: translateY(0px) scale(.985); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    button.primary{
      background: linear-gradient(135deg, rgba(119,255,214,.98), rgba(134,182,255,.92));
      color: rgba(0,0,0,.85);
      border-color: transparent;
      box-shadow: var(--glowAccent);
    }
    button.danger{
      background: rgba(255,107,136,.11);
      border-color: rgba(255,107,136,.28);
    }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      font-weight: 1000;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(119,255,214,.30); background: rgba(119,255,214,.12); color: rgba(119,255,214,.98); box-shadow: 0 0 24px rgba(119,255,214,.12); }
    .pill.late{ border-color: rgba(134,182,255,.28); background: rgba(134,182,255,.12); color: rgba(134,182,255,.98); box-shadow: 0 0 24px rgba(134,182,255,.12); }

    .readerTitle{ margin: 0; font-size: 22px; font-weight: 1000; text-shadow: 0 0 18px rgba(119,255,214,.10); }
    .readerMeta{ margin-top:6px; font-size: 13px; color: var(--muted); min-height: 18px; }
    .readerText{
      margin-top: 12px;
      white-space: pre-wrap;
      line-height: 1.78;
      font-size: 15.75px;
      color: rgba(255,255,255,.88);
      max-width: 72ch;
    }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }

    /* Calendar */
    .calTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .monthTitle{
      font-weight: 1000;
      font-size: 18px;
      text-align:center;
      min-width: 220px;
    }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 14px;
      padding: 0 4px;
    }
    .dow div{
      font-size: 12px;
      color: var(--muted);
      font-weight: 1000;
      padding: 0 6px;
    }
    .calendarGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .dayCell{
      min-height: 76px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.055);
      padding: 12px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .dayCell:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.085);
      border-color: rgba(255,255,255,.20);
    }
    .dayCell.muted{
      opacity:.25;
      cursor:default;
    }
    .dayCell.today{
      border-color: rgba(134,182,255,.62);
      box-shadow: 0 0 0 4px rgba(134,182,255,.14), 0 0 32px rgba(134,182,255,.14), 0 18px 60px rgba(0,0,0,.40);
    }
    .dayNum{
      font-weight: 1000;
      font-size: 14px;
    }
    .dayTag{
      position:absolute;
      right: 10px; top: 10px;
      font-size: 11px;
      font-weight: 1000;
      padding: 6px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .dayTag.ok{
      border-color: rgba(119,255,214,.30);
      background: rgba(119,255,214,.12);
      color: rgba(119,255,214,.98);
    }
    .dayTag.late{
      border-color: rgba(134,182,255,.28);
      background: rgba(134,182,255,.12);
      color: rgba(134,182,255,.98);
    }
    .dayTag.miss{
      border-color: rgba(255,107,136,.30);
      background: rgba(255,107,136,.12);
      color: rgba(255,107,136,.98);
    }

    /* Modal */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }
    .modal{
      width: min(900px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(8,12,24,.92);
      box-shadow: 0 25px 90px rgba(0,0,0,.75);
      overflow:hidden;
    }
    .mhd{
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,.04);
    }
    .mbd{ padding: 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .grid15{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 700px){
      .grid15{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .pchip{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
      font-weight: 1000;
      text-align:center;
      user-select:none;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .pchip:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.22); }
    .pchip.on{
      color: rgba(0,0,0,.84);
      border-color: transparent;
      background: linear-gradient(135deg, rgba(119,255,214,.98), rgba(134,182,255,.92));
      box-shadow: var(--glowAccent);
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    /* Progreso visual */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.055);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .stat.big{ grid-column: span 2; }
    .statLabel{
      font-size: 12px;
      color: var(--muted);
      font-weight: 1000;
    }
    .statValue{
      margin-top: 6px;
      font-size: 18px;
      font-weight: 1000;
    }

    .todayMeter{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items:center;
    }
    @media (max-width: 980px){
      .todayMeter{ grid-template-columns: 1fr; }
      .todayMeter .meterRing{ margin: 0 auto; }
    }

    .meterRing{
      width: 140px;
      height: 140px;
      border-radius: 999px;
      background: conic-gradient(var(--accent) 0deg, rgba(255,255,255,.10) 0deg);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
      position:relative;
      overflow:visible;
    }
    .meterRing::after{
      content:"";
      position:absolute;
      inset:-14px;
      border-radius:999px;
      background:
        radial-gradient(circle, rgba(119,255,214,.18), transparent 60%),
        radial-gradient(circle, rgba(134,182,255,.14), transparent 62%);
      filter: blur(10px);
      opacity: 0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .meterRing[data-progress="1"]::after{ opacity: .85; }

    .meterInner{
      width: 108px;
      height: 108px;
      border-radius: 999px;
      background: rgba(6,10,22,.85);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      position:relative;
      z-index:1;
    }
    .meterNum{
      font-size: 34px;
      font-weight: 1000;
      line-height: 1;
    }
    .meterSub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 1000;
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; }
    }
  </style>
</head>

<body>
<header>
  <h1>Santa Br√≠gida ¬∑ 15 oraciones</h1>
  <div class="sub">
    Reto de <b>365 d√≠as seguidos</b>. Cada d√≠a cuenta solo si completas <b>las 15</b>.
  </div>

  <div class="tabs">
    <div class="tab active" id="tabHoy">Hoy</div>
    <div class="tab" id="tabCal">Calendario</div>
  </div>
</header>

<main class="wrap">

  <!-- HOY -->
  <section id="viewHoy">
    <div class="grid">
      <section class="card">
        <div class="hd">
          <div>
            <div class="title">Lectura</div>
            <div class="muted" id="todayLine">‚Äî</div>
          </div>
          <div class="pill" id="pillState">‚Äî</div>
        </div>

        <div class="bd">
          <h2 class="readerTitle" id="prayerTitle">‚Äî</h2>
          <div class="readerMeta" id="prayerMeta"></div>
          <div class="readerText" id="prayerText">‚Äî</div>

          <div class="sep"></div>

          <div class="btnrow">
            <button id="prev">‚óÄ Anterior</button>
            <button id="toggle" class="primary">Marcar esta oraci√≥n</button>
            <button id="next">Siguiente ‚ñ∂</button>
          </div>

          <div class="btnrow">
            <button id="markDay" class="primary">‚úÖ Marcar HOY como completo (15/15)</button>
            <button id="clearToday">Reiniciar marcas de HOY</button>
          </div>

          <div class="hint">
            üìå Solo cuando tengas <b>15/15</b>, marca el d√≠a como completo.
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd">
          <div class="title">Progreso</div>
          <div class="pill" id="pillProgress">‚Äî</div>
        </div>

        <div class="bd">

          <div class="stats">
            <div class="stat">
              <div class="statLabel">Inicio</div>
              <div class="statValue mono" id="startDate">‚Äî</div>
            </div>

            <div class="stat">
              <div class="statLabel">Racha</div>
              <div class="statValue"><span id="streak">0</span><span class="muted">/365</span></div>
            </div>

            <div class="stat big">
              <div class="statLabel">Hoy</div>
              <div class="statValue"><span id="todayCount">0</span><span class="muted">/15</span></div>
            </div>
          </div>

          <div class="todayMeter" aria-label="Progreso de hoy">
            <div class="meterRing" id="meterRing">
              <div class="meterInner">
                <div class="meterNum" id="meterNum">0</div>
                <div class="meterSub">de 15</div>
              </div>
            </div>

            <div class="meterText">
              <div class="title" style="margin-bottom:6px;">Objetivo de hoy</div>
              <div class="muted" id="meterMsg">‚Äî</div>

              <div class="btnrow" style="margin-top:10px;">
                <button id="goCal">Ir al calendario</button>
                <!-- ‚úÖ aparece solo entre 00:00 y la hora de corte -->
                <button id="startNewDay" style="display:none;">üåÖ Empezar hoy</button>
                <button id="resetAll" class="danger">Reiniciar reto</button>
              </div>
            </div>
          </div>

        </div>
      </aside>
    </div>
  </section>

  <!-- CALENDARIO -->
  <section id="viewCal" style="display:none;">
    <section class="card">
      <div class="hd">
        <div>
          <div class="title">Calendario</div>
          <div class="muted" id="monthSummary">‚Äî</div>
        </div>

        <div class="calTop">
          <div class="row">
            <button id="calPrev">‚óÄ</button>
            <div class="monthTitle" id="calTitle">‚Äî</div>
            <button id="calNext">‚ñ∂</button>
          </div>
        </div>
      </div>

      <div class="bd">
        <div class="dow" id="dow"></div>
        <div class="calendarGrid" id="calGrid"></div>
        <div class="hint">Rango visible: <b>1 a√±o atr√°s</b> y <b>1 a√±o adelante</b> desde hoy.</div>
      </div>
    </section>
  </section>

</main>

<!-- MODAL -->
<div class="modalBg" id="modalBg" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd">
      <div class="title" id="modalTitle">D√≠a</div>
      <button id="modalClose">Cerrar</button>
    </div>
    <div class="mbd">
      <div class="row">
        <div class="pill"><b>Fecha:</b> <span class="mono" id="modalDate">‚Äî</span></div>
        <div class="pill"><b>Estado:</b> <span id="modalState">‚Äî</span></div>
        <div class="pill"><b>Registrado:</b> <span class="mono" id="modalReg">‚Äî</span></div>
      </div>

      <div class="btnrow">
        <button class="primary" id="modalMarkFull">‚úÖ Marcar d√≠a completo</button>
        <button id="modalClear">Quitar marca del d√≠a</button>
      </div>

      <div id="onlyTodayBlock" style="margin-top:12px;">
        <div class="sep"></div>
        <div class="title">HOY: marcar oraciones (1‚Äì15)</div>
        <div class="grid15" id="grid15"></div>
        <div class="hint">Estas marcas son solo para ayudarte a completar HOY. El reto cuenta cuando marcas el d√≠a completo.</div>
      </div>

      <div id="notTodayHint" class="pill" style="display:none; margin-top:12px;">
        Este d√≠a <b>no</b> se marca por oraciones. Solo puede estar ‚úÖ Hecho (15/15) o Falta.
      </div>
    </div>
  </div>
</div>

<script>
  /**********************
   * INTRO (ANTES DE TODO) ‚Äî SIN CREDO COMPLETO
   **********************/
  const INTRO = {
    title: "ORACIONES",
    text: `Para empezar, invoquemos al Dulce Hu√©sped de nuestras almas.

Se√±al de la Cruz.

Venid, Esp√≠ritu Santo, llenad los corazones de Vuestros fieles y encended en ellos el Fuego Eterno de Vuestro Amor. Enviad, Se√±or, Vuestro Esp√≠ritu, y todo ser√° creado, y se renovar√° la faz de la Tierra.

Oremos:

¬°Oh, Dios!, que instruisteis los corazones de Vuestros fieles con la Luz de Vuestro Esp√≠ritu Santo, concededme que, animado y guiado por este mismo Esp√≠ritu, aprenda a obrar rectamente siempre y goce de la Dulzura del Bien de Vuestros Divinos Consuelos. Por Cristo, nuestro Se√±or.

As√≠ sea.

Credo (de los Ap√≥stoles).`
  };

  /**********************
   * ORACI√ìN FINAL (NUEVA) ‚Äî VA DESPU√âS DE LA 15 (NO CUENTA EN 15/15)
   **********************/
  const FINAL_PRAYER = {
    title: "ORACI√ìN FINAL",
    text: `¬°Oh, Dulce Jes√∫s!, herid mi coraz√≥n a fin de que mis l√°grimas de amor y penitencia me sirvan de pan, d√≠a y noche. Convertidme enteramente, ¬°oh, mi Se√±or!, a Vos. Haced que mi coraz√≥n sea Vuestra Habitaci√≥n Perpetua y que mi conversaci√≥n Os sea agradable. Que el fin de mi vida Os sea de tal suerte loable que, despu√©s de mi muerte, pueda merecer Vuestro Para√≠so y alabarOs para siempre en el Cielo con todos Vuestros Santos.

Am√©n.

Sea por siempre bendito y alabado Jes√∫s, que con Su Sangre nos redimi√≥. (Tres veces)`
  };

  /**********************
   * 15 ORACIONES (COMPLETAS)
   **********************/
  const PRAYERS = [
    { key:"p1", title:"PRIMERA ORACI√ìN", text:`¬°Oh, Jes√∫s m√≠o!, ¬°oh, Eterna Dulzura para los que Os amamos!, ¬°oh, Gozo Supremo, que supera todo gozo y deseo!, ¬°oh, Salvaci√≥n y Esperanza nuestra!, infinitas pruebas nos hab√©is dado de que Vuestro mayor Deseo es estar siempre con nosotros, y fue este Sublime Deseo, ¬°oh, Bendito Amor!, el que Os llev√≥ a asumir la naturaleza humana. ¬°Oh, Verbo Encarnado!, recordad aquella Santa Pasi√≥n que abrazasteis por nosotros para cumplir el Divino Plan de Reconciliaci√≥n de Dios con su criatura. Recordad, Se√±or, Vuestra √öltima Cena, cuando rodeado de Vuestros disc√≠pulos y despu√©s de haberles lavado los pies, les disteis Vuestro Precioso Cuerpo y Sangre. Recordad tambi√©n cuando tuvisteis que consolarlos al anunciarles Vuestra ya pr√≥xima Pasi√≥n.

Fue en el Huerto de los Olivos, ¬°oh, Se√±or!, donde se escenificaron los peores momentos de Vuestra Sagrada Pasi√≥n: porque fuisteis invadido por la m√°s infinita de las tristezas y por la m√°s dolorosa de las amarguras, que Os llevaron a exclamar, lleno de Horror y de Angustia: "¬°Mi Alma est√° triste hasta la muerte!"... Tres Horas dur√≥ Vuestra Agon√≠a en aquel jard√≠n, y todo el Miedo, Angustia y Dolor que padecisteis all√≠ ¬°fueron tan grandes! que Os causaron sudar Sangre copiosamente. Aquello escapaba a toda descripci√≥n, hasta tal punto que sufristeis m√°s all√≠ que en el resto de Vuestra Pasi√≥n, porque ante Vuestros Divinos Ojos desfilaron aquellas terribles visiones de los pecados que se cometieron desde Ad√°n y Eva hasta aquellos mismos instantes, los pecados que se estaban cometiendo en aquellos momentos por toda la faz de la Tierra y los que se cometer√≠an en el futuro, ¬°siglos enteros!, hasta la consumaci√≥n de los Tiempos.

Pero, ¬°oh, Amor que todo lo vence!, a pesar de Vuestro Temor humano, as√≠ contestasteis a Vuestro Padre: "¬°No se haga mi voluntad, sino la Tuya!" E inmediatamente Vuestro Padre envi√≥ a aquel Precioso √Ångel para confortarOs. Tres veces orasteis, y al final lleg√≥ Vuestro disc√≠pulo traidor, Judas. ¬°Cu√°nto Os doli√≥ aquello!

Fuisteis arrestado por el pueblo de aquella naci√≥n que Vos mismo hab√≠ais escogido y exaltado. Tres jueces Os juzgaron, falsos testigos Os acusaron, cometiendo el acto m√°s injusto de la historia de la Humanidad, ¬°condenando a muerte a su Autor y Redentor!, ¬°a Aquel que ven√≠a a regalarnos la Vida Eterna!

Y Os despojaron de Vuestras vestiduras y Os cubrieron los Ojos... E inmediatamente aquellos soldados romanos comenzaron a abofetearOs y a llenarOs de salivazos. Golpes llovieron contra Vuestro Delicado Cuerpo, y Os retaban a que les dijerais qui√©n era el que Os lo hac√≠a. De repente, aquella Corona de Espinas Os la incrustaron, mutilando Vuestra Cabeza de mala manera, ¬°rompiendo Carne, Venas y Nervios! Y para completar la mofa a Vuestra Condici√≥n de Rey, Os dieron un cetro: una vulgar ca√±a que colocaron en Vuestras Sagradas Manos.

¬°Oh, Sublime Enamorado de nuestras almas!, recordad tambi√©n cuando Os ataron a la columna. ¬°C√≥mo Os flagel√≥ aquella gente!... No qued√≥ lugar alguno en Vuestro Maravilloso Cuerpo que no quedara destrozado bajo los golpes de los l√°tigos. Otro cuerpo humano hubiese muerto con menos golpes. La escena era terrible: ¬°Huesos y Costillas pod√≠an verse! ¬°Cu√°nta furia desatada contra el Hombre-Dios!

¬°Oh, Jes√∫s m√≠o!, en memoria de aquellos crueles Tormentos que padecisteis por nosotros antes de la Crucifixi√≥n, concededme, antes de morir, un verdadero arrepentimiento de mis pecados, que pueda satisfacer por ellos, haga una santa Confesi√≥n, Os reciba en la Sant√≠sima Eucarist√≠a y, as√≠ alimentada mi alma, pueda volar hacia Vos.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p2", title:"SEGUNDA ORACI√ìN", text:`¬°Oh, Salud y Alimento de mi alma, Libertad Verdadera de √°ngeles y santos!, ¬°Para√≠so de Delicias!, recordad el Horror y la Tristeza que sufristeis, camino del lugar donde Os aguardaban una cruz, cuatro clavos y los verdugos, cuando toda aquella turba se apretujaba a Vuestro Paso y Os golpeaba e insultaba impunemente, haci√©ndoOs v√≠ctima de las m√°s espantosas crueldades. Pero m√°s Os dol√≠a su ingratitud que los golpes que Os inflig√≠an, pues era precisamente por ellos y por todo el G√©nero Humano, que llevabais aquella Cruz sobre Vuestros Hombros destrozados.

Por todos aquellos Tormentos y Ultrajes, y por las blasfemias proferidas en contra de Vos, Os ruego, ¬°oh, Due√±o de mi alma!, que me libr√©is de mis enemigos, visibles e invisibles, y que bajo Vuestra Protecci√≥n logre tal perfecci√≥n y santidad que merezca entrar con Vos en Vuestro Reino.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p3", title:"TERCERA ORACI√ìN", text:`¬°Oh, Due√±o de nuestra existencia!, Vos, que siendo el Creador del Universo, del Cielo y de la Tierra, de √°ngeles y hombres, a quien nada puede abarcar ni limitar, y que todo lo envolv√©is y sosten√©is con Vuestro Amoroso Poder, sin embargo Os dejasteis matar por Vuestra Obra Maestra, el Hombre, para justificarlo ante Vos mismo.

Recordad cada Dolor sufrido, cada Tormento soportado por nuestro Amor, cuando los jud√≠os con enormes clavos taladraron Vuestras Sagradas Manos y Pies. ¬°Qu√© espantosa escena se produjo cuando, con indescriptible crueldad, Vuestro Cuerpo tuvo que ser estirado sobre la Cruz para que Vuestras Manos y Pies llegaran hasta los agujeros previamente abiertos en el madero! ¬°Con cu√°nta furia agrandaron aquellas Heridas! ¬°C√≥mo agregaron dolor al Dolor cuando tuvieron que estirar Vuestros Sagrados Miembros violentamente en todas direcciones!, ¬°oh, Var√≥n de Dolores!

Recordad cuando Vuestros M√∫sculos y Tendones eran estirados sin misericordia, Vuestras Venas se romp√≠an, Vuestra Piel Virginal se desgarraba horriblemente y Vuestros Huesos eran dislocados.

¬°Oh, Cordero Divino!, en memoria de todo lo ocurrido en la Colina del G√≥lgota, Os ruego me conced√°is la Gracia de amarOs y honrarOs cada d√≠a m√°s y m√°s.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p4", title:"CUARTA ORACI√ìN", text:`¬°Oh, Divino M√°rtir de Amor!, ¬°oh, M√©dico Celestial!, que Os dejasteis suspender en la Cruz para que por Vuestras Heridas, las nuestras fueran curadas. Recordad cada una de aquellas Heridas y la tremenda debilidad de Vuestros Miembros, que fueron distendidos hasta tal punto que jam√°s ha habido dolor semejante al Vuestro. Desde la Cabeza a los Pies erais todo Llaga, todo Dolor, todo Sufrimiento; erais una masa rota y sanguinolenta. Y aun as√≠ llegasteis, para sorpresa de Vuestros verdugos, a suplicar a Vuestro Padre Eterno, Perd√≥n para ellos dici√©ndoLe: ¬°Padre, perd√≥nalos, porque no saben lo que hacen!

¬°Oh, Cristo Bendito!, en memoria de esta gran Misericordia que tuvisteis -ya que muy bien pudisteis lanzar a todo aquel mundo malvado a los abismos infernales con un solo Acto de Vuestra Poderosa Voluntad-, por aquella tan grande Misericordia que super√≥ a Vuestra Divina Justicia, concededme una contrici√≥n perfecta y la remisi√≥n total de mis pecados, desde el primero hasta el √∫ltimo, y que jam√°s vuelva a ofenderOs.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p5", title:"QUINTA ORACI√ìN", text:`¬°Oh, Jes√∫s!, ¬°oh, Esplendor de la Eternidad!, recordad cuando contemplasteis en la Luz de Vuestra Divinidad las almas de los predestinados, que ser√≠an rescatados por los M√©ritos de Vuestra Sagrada Pasi√≥n. Tambi√©n visteis aquella tremenda multitud que ser√≠a condenada por sus pecados. ¬°Cu√°nto Os quejasteis por ellos! Os compadecisteis, ¬°oh, Buen Jes√∫s!, hasta de aquellos r√©probos, de aquellos desafortunados pecadores que no se lavar√≠an con Vuestra Sangre ni se alimentar√≠an con Vuestra Carne Eucar√≠stica.

Por Vuestra Infinita Compasi√≥n y Piedad, y acord√°ndoOs de Vuestra Promesa al buen ladr√≥n arrepentido, al decirle que aquel mismo d√≠a estar√≠a con Vos en el Para√≠so, ¬°oh, Salud y Alimento de nuestra alma!, mostradme esta misma Misericordia en la Hora de mi muerte.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p6", title:"SEXTA ORACI√ìN", text:`¬°Oh, Rey muy amado y deseado por mi coraz√≥n!, acordaOs del Dolor que sufristeis cuando, desnudo y como un criminal com√∫n y corriente, fuisteis clavado y elevado en la Cruz. ¬°C√≥mo Os doli√≥ ver que Vuestros familiares y amigos desertaban! Pero all√≠ estaba Vuestra Muy Amada Madre y Vuestro Disc√≠pulo Juan, que permanecieron con Vos hasta Vuestro √öltimo Suspiro, no importando que su naturaleza humana desmayando estuviera. Y, para colmo de Vuestro Inmenso Amor por nosotros, nos hicisteis aquel Precioso Regalo: ¬°nos disteis a Mar√≠a como Madre! ¬°Cu√°nto Os debemos, Salvador nuestro, por este Sublime Regalo! Solo tuvisteis que decir a Mar√≠a: ‚Äú¬°Mujer, he aqu√≠ a tu hijo!‚Äù, y a Juan: ‚Äú!He aqu√≠ a tu Madre!‚Äù

Os suplico, ¬°oh, Rey de la Gloria!, por la Espada de Dolor que entonces atraves√≥ el alma de Vuestra Sant√≠sima e Inmaculada Madre, que Os compadezc√°is de m√≠ en todas mis aflicciones y tribulaciones, tanto corporales como espirituales, y que me asist√°is en cada prueba, especialmente en la Hora de mi muerte.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p7", title:"S√âPTIMA ORACI√ìN", text:`¬°Oh, Rey de Reyes!, ¬°Fuente de Compasi√≥n que jam√°s se agota!, recordad cuando sentisteis aquella tremenda Sed por las almas, que Os llev√≥ a exclamar desde la Cruz: "¬°Tengo Sed!" S√≠, no solamente ten√≠ais Sed f√≠sica, sino Sed insaciable por la Salvaci√≥n de la Raza Humana.

Por este gesto de Amor por nosotros, Os ruego, ¬°oh, Prisionero de nuestro amor!, que inflam√©is mi coraz√≥n con el deseo de tender siempre hacia la perfecci√≥n en todos mis actos, que exting√°is en m√≠ la concupiscencia de la carne y los deseos de placeres mundanos.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p8", title:"OCTAVA ORACI√ìN", text:`¬°Oh, constante Dulzura nuestra!, ¬°oh, Deleite diario de nuestro esp√≠ritu!, por el sabor tan amargo de aquella hiel y vinagre que Os dieron a probar en lugar de agua, para aplacar Vuestra Sed f√≠sica, Os suplico que aplaqu√©is mi sed por Vuestra Vivificadora Sangre y mi hambre por Vuestra Redentora Carne, ahora y siempre, y que no me falten en la Hora de mi muerte.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p9", title:"NOVENA ORACI√ìN", text:`¬°Oh, Jes√∫s, Virtud Real y Gozo del alma!, acordaOs del Dolor que sentisteis, sumergido en un Oc√©ano de Amargura, al acercarse la Muerte. Insultado y ultrajado por Vuestros verdugos, clamasteis en alta voz que hab√≠ais sido abandonado por Vuestro Padre Celestial, dici√©ndoLe: ‚ÄúDios m√≠o, Dios m√≠o, ¬øpor qu√© me has abandonado?‚Äù Por aquella Angustia que padecisteis en aquellos momentos finales de Vuestra Pasi√≥n, Os ruego, ¬°oh, nuestro Salvador!, que no me abandon√©is durante los terrores y dolores de mi muerte.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p10", title:"D√âCIMA ORACI√ìN", text:`¬°Oh, Jes√∫s!, que sois Principio y Fin de todo lo creado, Virtud, Luz y Verdad, acordaOs de que por causa nuestra fuisteis sumergido en un Abismo de Penas, sufriendo Dolor en todo Vuestro Sant√≠simo Cuerpo. En consideraci√≥n a la enormidad de tanta Llaga que Os hicimos los hombres, ense√±adme a guardar por puro amor a Vos todos Vuestros Mandamientos, que son Camino de Vuestra Ley Divina, amplio y agradable para aquellos que Os aman.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p11", title:"UND√âCIMA ORACI√ìN", text:`¬°Oh, Jes√∫s m√≠o, Abismo Insondable de Misericordia!, Os ruego, en memoria de Vuestras Heridas, las cuales penetraron hasta la M√©dula de Vuestros Huesos y hasta lo m√°s profundo de Vuestro Ser, ¬°que me apart√©is para siempre del pecado!, ¬°que no Os ofenda m√°s! Reconozco con bochorno que soy un miserable pecador y que Os he ofendido ¬°tantas veces! que temo que Vuestra Divina Justicia me condene.

No obstante, acudo presuroso a Vuestra Misericordia Infinita para que me escond√°is urgentemente en Vuestras Preciosas Llagas. Y as√≠, ocultado de Vuestro indignado Rostro, pueda Vuestro Amante Coraz√≥n una vez m√°s lavar mis culpas con Vuestra Sangre Liberadora. De esa forma, Redentor nuestro, Vuestro Enojo e Indignaci√≥n cesar√°n de inmediato. ¬°Gracias, Se√±or!

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p12", title:"DUOD√âCIMA ORACI√ìN", text:`¬°Oh, Jes√∫s, Eterna Verdad, S√≠mbolo de la Perfecta Caridad y de la Unidad!, Os suplico que Os acord√©is de aquella multitud de laceraciones, de aquellas horribles Heridas que Os hicimos la Humanidad pecadora que quer√≠ais salvar. Estabais hecho un gui√±apo humano, enrojecido por Vuestra propia Sangre. ¬°Qu√© inmenso e intenso Dolor padecisteis en Vuestra Carne Virginal por Amor a nosotros!, ¬°oh, Dulzura Infinita! ¬øQu√© pod√©is hacer que no hay√°is ya hecho por nosotros? Nada falta, todo lo hab√©is cumplido.

Ayudadme, ¬°oh, Se√±or!, a tener siempre presente ante los ojos de mi esp√≠ritu un fiel recuerdo de Vuestra Pasi√≥n, para que el Fruto de Vuestros Sufrimientos se vea continuamente renovado en mi alma y para que Vuestro Amor se agrande en cada momento m√°s y m√°s en mi coraz√≥n, hasta que llegue aquel Feliz D√≠a en que Os vea en el Cielo y sea Uno con Vos, que sois el Tesoro y Suma Total de todo gozo y bondad.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p13", title:"D√âCIMA TERCERA ORACI√ìN", text:`¬°Oh, Dulce Consuelo de mi alma, Maravilloso Liberador, Rey Inmortal e Invencible!, recordad cuando, inclinando Vuestra Adorable Cabeza, toda desfigurada por los golpes, la Sangre y el polvo del camino, exclamasteis: "Todo est√° consumado"... Toda Vuestra Fuerza, mental y f√≠sica, se agot√≥ completamente.

Por este Gran Sacrificio y por las Angustias y Tormentos que padecisteis antes de morir, Os ruego, ¬°oh, Buen Jes√∫s!, que teng√°is Misericordia de m√≠ en la Hora de mi muerte, cuando mi mente est√© tremendamente perturbada y mi alma sumergida en inquietudes y angustias. Que no tema nada, que Os tenga a Vos a mi lado y dentro de mi ser.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p14", title:"D√âCIMA CUARTA ORACI√ìN", text:`¬°Oh, Doliente Jes√∫s!, ¬°oh, incomprensible Segunda Persona de la Trinidad, Esplendor y Figura de Su Esencia!, recordad cuando con gran Voz entregasteis Vuestra Alma a Vuestro Padre Celestial, dici√©ndoLe: "¬°Padre, en Tus Manos encomiendo mi esp√≠ritu!" Vuestro Cuerpo estaba despedazado y Vuestro Coraz√≥n destrozado, pero Vuestras Entra√±as de Misericordia quedaron abiertas para redimirnos. As√≠ expiraste, ¬°oh, Amor Infinito!

Por Vuestra Dolorosa Muerte Os suplico, ¬°oh, Rey de Santos y √Ångeles!, que me confort√©is y ayud√©is a resistir al mundo con sus errores, a Satan√°s con sus perfidias y a la carne con sus vicios, para que as√≠, muerto a los enemigos de mi alma, viva solamente para Vos. Por eso Os ruego, ¬°oh, Dulce Redentor y Salvador!, que a la Hora de mi muerte recib√°is mi pobre alma desterrada, que regresa a Vos.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },

    { key:"p15", title:"D√âCIMA QUINTA ORACI√ìN", text:`¬°Oh, Vencedor de la Muerte!, ¬°Vid Verdadera y Fruct√≠fera!, recordad aquel torrente de Sangre que brot√≥ de cada Parte de Vuestro Bendito Cuerpo, igual que la uva exprimida en el lagar.

Desde el lugar de la Flagelaci√≥n y a trav√©s de las calles de Jerusal√©n, por toda aquella V√≠a Dolorosa hasta la Colina Sagrada, Vuestra Sangre derramada escrib√≠a las Bellas P√°ginas de la Historia del Coraz√≥n que m√°s nos ama...¬°El Vuestro! Recordad c√≥mo la Tierra, agradecida pero a la vez espantada, recib√≠a Vuestra Preciosa Sangre. Toda la Naturaleza, de horror temblaba, y los cielos se estremec√≠an; los √Ångeles y hasta los demonios se sorprend√≠an ante ¬°aquella incre√≠ble escena! ¬°Todo un Dios mor√≠a! ¬øQu√© era aquello? ¬øQu√© suced√≠a? Aquel primer Viernes Santo, ¬°oh, Jes√∫s!, ¬°abr√≠ais el Cielo para la Humanidad pecadora!

Por tres largas Horas Vuestro Cuerpo colg√≥ de la Cruz. Presentabais un aspecto doliente, triste, todo lleno de Dolor. Vuestra Sangre: a√∫n manando, recorriendo aquella que ya se hab√≠a secado, que ya se hab√≠a coagulado. Y a todo esto se adhiri√≥ el polvo y la tierra del camino....

Qu√© tristeza y dolor padecieron Mar√≠a y Juan al contemplar Vuestros Cabellos y Barbas, que ahora daban la impresi√≥n de que estaban compuestos de alambres, llenos de Sangre y de tierra. Vuestros O√≠dos y Nariz, tupidos estaban de Sangre. ¬°Hasta Vuestros Ojos y Boca sangraban! En verdad que todos Vuestros Sentidos fueron atrozmente atormentados.

As√≠ inclinasteis la Cabeza y entregasteis Vuestro Esp√≠ritu.... Entonces vino Longinos y perfor√≥ Vuestro Costado, con tanta violencia que la punta de la lanza casi sale por el otro Costado. Vuestro Coraz√≥n, Os lo desgarraron, ¬°oh, Jes√∫s!, ese Coraz√≥n que ¬°tanto nos ama! Y de all√≠ brot√≥ Sangre y Agua, hasta no quedar en Vuestro Cuerpo gota alguna. Vuestro Cuerpo era cual bulto colgado, como un haz de mirra elevado en lo alto de la Cruz. La muy fina y delicada Carne Vuestra fue destrozada, la Sustancia de Vuestro Cuerpo fue marchitada, y desecada la M√©dula de Vuestros Huesos. Fue entonces que el Sol y las estrellas negaron su luz, hubo terremotos, y la Naturaleza y los Elementos dieron amplio testimonio de que Aquel que negaron ¬°era el Hijo de Dios!

Por esta Amarga Pasi√≥n y por la Efusi√≥n de Vuestra Divina Sangre, Os suplico, ¬°oh, Dulc√≠simo Jes√∫s!, que recib√°is mi alma cuando est√© sufriendo en la agon√≠a de mi muerte.

¬°Oh, Maravillosa Realidad, esc√°ndalo para los infieles, Gozo indescriptible para los que Os amamos!, ese Vuestro Infinito Sacrificio pag√≥ el Rescate, y al resucitar y ascender gloriosamente al Cielo ¬°dejasteis bien abiertas las Puertas para aquellos que quisieran seguirOs! ¬°Oh, Se√±or!, por Vuestra Amarga Pasi√≥n y Preciosa Sangre Os ruego traspas√©is mi coraz√≥n para que mis l√°grimas de amor, adoraci√≥n y penitencia sean mi alimento noche y d√≠a. Haced que me convierta totalmente a Vos, que mi coraz√≥n sea Vuestro perpetuo Lugar de Reposo, que mis conversaciones Os sean siempre agradables, y que al final de mi vida merezca que grab√©is, ¬°oh, Dios de Amor!, el Sello de Vuestra Divinidad en mi alma, para que tanto el Padre como el Esp√≠ritu Santo Os vean bien reproducido en m√≠ y poder as√≠ ser contado entre Vuestros Santos para que Os alabe para siempre por toda la Eternidad.

As√≠ sea.

(Padre Nuestro, Ave Mar√≠a y Gloria)` },
  ];

  /**********************
   * STORAGE
   **********************/
  const STORE_KEY = "brigida365_visual_clean_v2";
  const KEYS = PRAYERS.map(p => p.key);
  const MAX_INDEX = 15; // -1 = INTRO, 0..14 = 15 oraciones, 15 = ORACI√ìN FINAL

  const DOW = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
  const MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  const $ = (id)=>document.getElementById(id);
  const pad = (n)=>String(n).padStart(2,"0");
  const ymd = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const parseYMD = (s)=>{ const [y,m,dd]=s.split("-").map(Number); return new Date(y, m-1, dd); };

  // ===========================
  // ‚úÖ CIERRE DE D√çA A LAS 04:00
  // ===========================
  const DAY_CUTOFF_HOUR = 4;

  // "Hoy" del reto: entre 00:00 y 03:59 sigue siendo el d√≠a anterior
  const todayYMD = ()=>{
    const d = new Date();
    d.setHours(d.getHours() - DAY_CUTOFF_HOUR);
    return ymd(d);
  };

  // Fecha real (para el bot√≥n ‚ÄúEmpezar hoy‚Äù)
  const calendarYMD = ()=> ymd(new Date());

  const isoNow = ()=> new Date().toISOString();
  const addDays = (date, n)=>{ const d = new Date(date); d.setDate(d.getDate()+n); return d; };
  const startOfMonth = (d)=> new Date(d.getFullYear(), d.getMonth(), 1);
  const endOfMonth = (d)=> new Date(d.getFullYear(), d.getMonth()+1, 0);
  const monFirstIndex = (date)=>{ const js = date.getDay(); return (js + 6) % 7; };

  function loadState(){
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw){
      const t = todayYMD();
      return {
        startDate: t,
        today: t,
        currentIndex: -1,
        doneToday: {},
        days: {}
      };
    }
    try { return JSON.parse(raw); }
    catch { localStorage.removeItem(STORE_KEY); return loadState(); }
  }
  function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  function ensureDay(dateStr){
    if(!state.days[dateStr]) state.days[dateStr] = { marks:{}, registeredAtISO:null };
    return state.days[dateStr];
  }
  function getDay(dateStr){ return state.days[dateStr] || null; }
  function countMarks(marks){
    let c = 0;
    for(const k of KEYS) if(marks?.[k]) c++;
    return c;
  }
  function isComplete(dateStr){
    const rec = getDay(dateStr);
    return rec ? (countMarks(rec.marks) === 15) : false;
  }
  function markFullDay(dateStr){
    const rec = ensureDay(dateStr);
    for(const k of KEYS) rec.marks[k] = true;
    rec.registeredAtISO = isoNow();
    saveState();
  }
  function clearDay(dateStr){
    delete state.days[dateStr];
    saveState();
  }

  function setTodayIfNeeded(){
    const t = todayYMD(); // ‚úÖ l√≥gico (cambia a las 04:00)
    if(state.today !== t){
      state.today = t;
      state.currentIndex = -1;
      state.doneToday = {};
      saveState();
    }
  }

  function firstDoneDay(){
    return Object.keys(state.days)
      .filter(ds => isComplete(ds))
      .sort()[0] || null;
  }

  function computeChallenge(){
    const firstDone = firstDoneDay();
    if(!firstDone){
      return { streak: 0, brokenOn: null, done365: false, startReal: null };
    }

    const start = parseYMD(firstDone);
    let streak = 0;
    let brokenOn = null;

    for(let i=0;i<365;i++){
      const ds = ymd(addDays(start,i));
      if(isComplete(ds)) streak++;
      else { brokenOn = ds; break; }
    }
    return { streak, brokenOn, done365: streak>=365, startReal: firstDone };
  }

  /**********************
   * RANGO CALENDARIO
   **********************/
  const TODAY = new Date();
  const MIN_DATE = new Date(TODAY.getFullYear() - 1, TODAY.getMonth(), 1);
  const MAX_DATE = new Date(TODAY.getFullYear() + 1, TODAY.getMonth() + 1, 0);

  /**********************
   * UI
   **********************/
  let state = loadState();
  setTodayIfNeeded();

  let view = "hoy";
  let calMonth = new Date();
  let modalDateStr = null;

  function setView(v){
    view = v;
    $("viewHoy").style.display = (v==="hoy") ? "block" : "none";
    $("viewCal").style.display = (v==="cal") ? "block" : "none";
    $("tabHoy").classList.toggle("active", v==="hoy");
    $("tabCal").classList.toggle("active", v==="cal");
    renderAll();
  }

  function renderToday(){
    const t = todayYMD(); // ‚úÖ l√≥gico
    $("todayLine").textContent = `Fecha: ${t}`;

    const ch = computeChallenge();

    $("startDate").textContent = ch.startReal || state.startDate;
    $("streak").textContent = ch.streak;

    const doneCount = KEYS.filter(k=>state.doneToday[k]).length;
    $("todayCount").textContent = doneCount;

    if(ch.done365){
      $("pillProgress").className = "pill ok";
      $("pillProgress").textContent = "üéâ Meta completada";
    } else if(ch.brokenOn){
      $("pillProgress").className = "pill";
      $("pillProgress").textContent = "Revisar calendario";
    } else if(ch.startReal){
      $("pillProgress").className = "pill";
      $("pillProgress").textContent = "En progreso";
    } else {
      $("pillProgress").className = "pill";
      $("pillProgress").textContent = "Empieza marcando un d√≠a ‚úÖ";
    }

    // c√≠rculo HOY
    $("meterNum").textContent = doneCount;
    const deg = Math.round((doneCount / 15) * 360);
    $("meterRing").style.background = `conic-gradient(var(--accent) ${deg}deg, rgba(255,255,255,.10) 0deg)`;
    $("meterRing").dataset.progress = (doneCount > 0) ? "1" : "0"; // ‚úÖ halo cuando hay progreso
    $("meterMsg").textContent = (doneCount === 15)
      ? "‚úÖ Ya puedes marcar HOY como completo."
      : "Marca las 15 oraciones y luego ‚ÄúMarcar HOY como completo‚Äù.";

    // ‚úÖ Bot√≥n ‚ÄúEmpezar hoy‚Äù (solo entre 00:00 y 04:00)
    const real = calendarYMD();   // fecha real
    const logical = todayYMD();   // fecha del reto
    const inNightWindow = (real !== logical);
    const btnNew = $("startNewDay");
    if(btnNew){
      btnNew.style.display = inNightWindow ? "inline-block" : "none";
      btnNew.textContent = `üåÖ Empezar hoy (${real})`;
    }

    // Render lectura: INTRO / 15 / FINAL
    if(state.currentIndex === -1){
      $("prayerTitle").textContent = INTRO.title;
      $("prayerMeta").textContent = "";
      $("prayerText").textContent = INTRO.text;

      $("pillState").className = "pill";
      $("pillState").textContent = "Inicio";

      $("toggle").disabled = true;
      $("toggle").textContent = "Marcar esta oraci√≥n";
    } else if(state.currentIndex === 15){
      $("prayerTitle").textContent = FINAL_PRAYER.title;
      $("prayerMeta").textContent = "Despu√©s de la 15¬™ (no cuenta en 15/15)";
      $("prayerText").textContent = FINAL_PRAYER.text;

      $("pillState").className = "pill";
      $("pillState").textContent = "Final";

      $("toggle").disabled = true;
      $("toggle").textContent = "Marcar esta oraci√≥n";
    } else {
      const p = PRAYERS[state.currentIndex];
      const done = !!state.doneToday[p.key];

      $("prayerTitle").textContent = p.title;
      $("prayerMeta").textContent = `Oraci√≥n ${state.currentIndex+1}/15`;
      $("prayerText").textContent = p.text;

      $("pillState").className = "pill " + (done ? "ok" : "");
      $("pillState").textContent = done ? "‚úÖ Hecha" : "Actual";

      $("toggle").disabled = false;
      $("toggle").textContent = done ? "Marcar pendiente" : "Marcar esta oraci√≥n";
    }

    $("prev").disabled = (state.currentIndex === -1);
    $("next").disabled = (state.currentIndex === MAX_INDEX);
    $("markDay").disabled = (doneCount !== 15);
  }

  function renderCalendar(){
    $("calTitle").textContent = `${MONTHS[calMonth.getMonth()]} ${calMonth.getFullYear()}`;

    const monthStart = startOfMonth(calMonth);
    const monthEnd = endOfMonth(calMonth);
    $("calPrev").disabled = monthStart <= MIN_DATE;
    $("calNext").disabled = monthEnd >= MAX_DATE;

    const mStart = startOfMonth(calMonth);
    const mEnd = endOfMonth(calMonth);
    let ok = 0, active = 0;
    for(let d=new Date(mStart); d<=mEnd; d=addDays(d,1)){
      if(d < MIN_DATE || d > MAX_DATE) continue;
      active++;
      if(isComplete(ymd(d))) ok++;
    }
    $("monthSummary").textContent = `Este mes: ${ok}/${active} d√≠as ‚úÖ Hecho`;

    $("dow").innerHTML = "";
    DOW.forEach(x=>{
      const el = document.createElement("div");
      el.textContent = x;
      $("dow").appendChild(el);
    });

    const grid = $("calGrid");
    grid.innerHTML = "";

    const firstIdx = monFirstIndex(mStart);
    const daysInMonth = mEnd.getDate();
    const today = todayYMD(); // ‚úÖ l√≥gico para resaltar ‚Äúhoy‚Äù seg√∫n tu reto

    const ch = computeChallenge();
    const startReal = ch.startReal ? parseYMD(ch.startReal) : null;
    const endReal = startReal ? addDays(startReal, 364) : null;

    for(let i=0;i<firstIdx;i++){
      const blank = document.createElement("div");
      blank.className = "dayCell muted";
      blank.style.visibility = "hidden";
      grid.appendChild(blank);
    }

    for(let day=1; day<=daysInMonth; day++){
      const date = new Date(calMonth.getFullYear(), calMonth.getMonth(), day);
      const ds = ymd(date);
      const outOfRange = (date < MIN_DATE) || (date > MAX_DATE);

      const cell = document.createElement("div");
      cell.className = "dayCell" + (outOfRange ? " muted" : "");
      if(ds === today) cell.classList.add("today");

      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = day;
      cell.appendChild(num);

      if(isComplete(ds)){
        const rec = getDay(ds);
        const reg = rec?.registeredAtISO ? rec.registeredAtISO.slice(0,10) : ds;
        const late = reg !== ds;
        const tag = document.createElement("div");
        tag.className = "dayTag " + (late ? "late" : "ok");
        tag.textContent = late ? "‚úÖ Hecho (tarde)" : "‚úÖ Hecho";
        cell.appendChild(tag);
      } else {
        if(startReal && endReal && (date >= startReal) && (date <= endReal) && (ds <= today)){
          const tag = document.createElement("div");
          tag.className = "dayTag miss";
          tag.textContent = "Falta";
          cell.appendChild(tag);
        }
      }

      if(!outOfRange){
        cell.onclick = ()=> openModal(ds);
      }

      grid.appendChild(cell);
    }
  }

  function openModal(dateStr){
    modalDateStr = dateStr;

    const today = todayYMD(); // ‚úÖ l√≥gico
    const isToday = (dateStr === today);

    const rec = getDay(dateStr);
    const marks = rec ? countMarks(rec.marks) : 0;
    const complete = (marks === 15);

    $("modalTitle").textContent = `D√≠a ${dateStr}`;
    $("modalDate").textContent = dateStr;
    $("modalState").textContent = complete ? "‚úÖ Hecho" : "Falta";
    $("modalReg").textContent = rec?.registeredAtISO ? rec.registeredAtISO.slice(0,10) : "‚Äî";

    $("onlyTodayBlock").style.display = isToday ? "block" : "none";
    $("notTodayHint").style.display = isToday ? "none" : "block";

    if(isToday){
      const g = $("grid15");
      g.innerHTML = "";
      for(let i=0;i<15;i++){
        const key = KEYS[i];
        const on = !!state.doneToday[key];

        const chip = document.createElement("div");
        chip.className = "pchip" + (on ? " on" : "");
        chip.textContent = `${i+1}`;

        chip.onclick = ()=>{
          state.doneToday[key] = !state.doneToday[key];
          saveState();
          openModal(dateStr);
          renderAll();
        };

        g.appendChild(chip);
      }
    }

    $("modalBg").style.display = "flex";
  }

  function closeModal(){
    $("modalBg").style.display = "none";
    modalDateStr = null;
  }

  function renderAll(){
    setTodayIfNeeded();
    if(state.currentIndex < -1) state.currentIndex = -1;
    if(state.currentIndex > MAX_INDEX) state.currentIndex = MAX_INDEX;

    renderToday();
    if(view === "cal") renderCalendar();
  }

  // Tabs
  $("tabHoy").onclick = ()=> setView("hoy");
  $("tabCal").onclick = ()=> setView("cal");
  $("goCal").onclick = ()=> setView("cal");

  // ‚úÖ Forzar empezar el d√≠a nuevo (solo aparece entre 00:00 y 04:00)
  $("startNewDay").onclick = ()=>{
    const real = calendarYMD();
    state.today = real;
    state.currentIndex = -1;
    state.doneToday = {};
    saveState();
    renderAll();
  };

  // Navegaci√≥n lectura
  $("prev").onclick = ()=>{
    state.currentIndex = Math.max(-1, state.currentIndex - 1);
    saveState(); renderAll();
  };
  $("next").onclick = ()=>{
    state.currentIndex = Math.min(MAX_INDEX, state.currentIndex + 1);
    saveState(); renderAll();
  };

  // Marcar oraci√≥n HOY (solo 1..15)
  $("toggle").onclick = ()=>{
    if(state.currentIndex < 0 || state.currentIndex > 14) return;
    const key = PRAYERS[state.currentIndex].key;
    state.doneToday[key] = !state.doneToday[key];
    saveState(); renderAll();
  };

  // Marcar HOY como completo
  $("markDay").onclick = ()=>{
    const doneCount = KEYS.filter(k=>state.doneToday[k]).length;
    if(doneCount !== 15) return;
    markFullDay(todayYMD());
    alert("‚úÖ HOY marcado como completado.");
    renderAll();
  };

  // Reiniciar marcas HOY
  $("clearToday").onclick = ()=>{
    state.doneToday = {};
    state.currentIndex = -1;
    saveState(); renderAll();
  };

  // Navegaci√≥n calendario
  $("calPrev").onclick = ()=>{
    calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1);
    renderAll();
  };
  $("calNext").onclick = ()=>{
    calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1);
    renderAll();
  };

  // Modal
  $("modalClose").onclick = closeModal;
  $("modalBg").onclick = (e)=>{ if(e.target.id === "modalBg") closeModal(); };

  // Marcar d√≠a completo en modal (cualquier d√≠a)
  $("modalMarkFull").onclick = ()=>{
    if(!modalDateStr) return;
    markFullDay(modalDateStr);

    if(modalDateStr === todayYMD()){
      for(const k of KEYS) state.doneToday[k] = true;
      saveState();
    }
    openModal(modalDateStr);
    renderAll();
  };

  // Quitar marca del d√≠a
  $("modalClear").onclick = ()=>{
    if(!modalDateStr) return;
    clearDay(modalDateStr);

    if(modalDateStr === todayYMD()){
      state.doneToday = {};
      saveState();
    }
    openModal(modalDateStr);
    renderAll();
  };

  // Reiniciar reto completo
  $("resetAll").onclick = ()=>{
    if(confirm("¬øSeguro? Esto borra todo el historial y reinicia el reto desde hoy.")){
      localStorage.removeItem(STORE_KEY);
      state = loadState();
      calMonth = new Date();
      setView("hoy");
    }
  };

  // Init
  setView("hoy");
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
